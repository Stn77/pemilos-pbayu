<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pembuat Password untuk Data Siswa</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }

        .card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 25px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        input[type="number"], input[type="checkbox"] {
            margin-right: 10px;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
        }

        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
            display: block;
            margin: 20px auto;
        }

        button:hover {
            background-color: #2980b9;
        }

        button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }

        #fileInput {
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
        }

        #preview {
            margin-top: 20px;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
            font-weight: 600;
        }

        .hidden {
            display: none;
        }

        .success-message {
            background-color: #d4edda;
            color: #155724;
            padding: 12px;
            border-radius: 4px;
            margin-top: 20px;
            text-align: center;
        }

        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 4px;
            margin-top: 20px;
            text-align: center;
        }

        .file-info {
            background-color: #e8f4fd;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            font-size: 14px;
        }

        .calculator {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
        }

        .calculator h4 {
            margin-top: 0;
            color: #2c3e50;
        }

        .combinations {
            font-weight: bold;
            color: #e74c3c;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <h1>Pembuat Password untuk Data Siswa</h1>

    <div class="card">
        <div class="form-group">
            <label for="fileInput">Unggah File Excel Data Siswa:</label>
            <input type="file" id="fileInput" accept=".xlsx, .xls">
            <div id="fileInfo" class="file-info hidden"></div>
        </div>

        <div class="form-group">
            <label for="passwordLength">Jumlah Karakter Password:</label>
            <input type="number" id="passwordLength" min="6" max="20" value="5">
        </div>

        <div class="form-group">
            <label>Jenis Karakter Password:</label>
            <div class="checkbox-group">
                <div class="checkbox-item">
                    <input type="checkbox" id="includeUppercase" checked>
                    <label for="includeUppercase">Huruf Kapital (A-Z)</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="includeLowercase" checked>
                    <label for="includeLowercase">Huruf Kecil (a-z)</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="includeNumbers" checked>
                    <label for="includeNumbers">Angka (0-9)</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="includeSymbols">
                    <label for="includeSymbols">Simbol (!@#$%^&*)</label>
                </div>
            </div>
        </div>

        <div class="calculator">
            <h4>Kalkulator Kombinasi Password</h4>
            <p>Total kombinasi yang mungkin: <span id="combinationsCount" class="combinations">0</span></p>
            <p><small>Password dengan kombinasi lebih dari 1 juta dianggap cukup aman</small></p>
        </div>

        <button id="generateBtn" disabled>Buat Password & Unduh File</button>
    </div>

    <div id="preview" class="card hidden">
        <h3>Pratinjau Data</h3>
        <div id="tableContainer"></div>
    </div>

    <div id="message" class="hidden"></div>

    <!-- Include SheetJS library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.getElementById('fileInput');
            const fileInfo = document.getElementById('fileInfo');
            const passwordLength = document.getElementById('passwordLength');
            const includeUppercase = document.getElementById('includeUppercase');
            const includeLowercase = document.getElementById('includeLowercase');
            const includeNumbers = document.getElementById('includeNumbers');
            const includeSymbols = document.getElementById('includeSymbols');
            const generateBtn = document.getElementById('generateBtn');
            const preview = document.getElementById('preview');
            const tableContainer = document.getElementById('tableContainer');
            const message = document.getElementById('message');
            const combinationsCount = document.getElementById('combinationsCount');

            let uploadedData = null;
            let originalFileName = '';

            // Update kombinasi saat pengaturan berubah
            function updateCombinations() {
                const length = parseInt(passwordLength.value);
                const charCount = calculateCharacterCount();
                const combinations = Math.pow(charCount, length);
                combinationsCount.textContent = combinations.toLocaleString('id-ID');

                // Warna berdasarkan keamanan
                if (combinations < 1000000) {
                    combinationsCount.style.color = '#e74c3c'; // Merah untuk tidak aman
                } else if (combinations < 1000000000) {
                    combinationsCount.style.color = '#f39c12'; // Oranye untuk cukup aman
                } else {
                    combinationsCount.style.color = '#27ae60'; // Hijau untuk aman
                }
            }

            function calculateCharacterCount() {
                let count = 0;
                if (includeUppercase.checked) count += 26;
                if (includeLowercase.checked) count += 26;
                if (includeNumbers.checked) count += 10;
                if (includeSymbols.checked) count += 8;
                return count;
            }

            // Event listeners untuk update kombinasi
            passwordLength.addEventListener('input', updateCombinations);
            includeUppercase.addEventListener('change', updateCombinations);
            includeLowercase.addEventListener('change', updateCombinations);
            includeNumbers.addEventListener('change', updateCombinations);
            includeSymbols.addEventListener('change', updateCombinations);

            // Inisialisasi kombinasi
            updateCombinations();

            // Handle file upload
            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;

                originalFileName = file.name;

                // Tampilkan info file
                fileInfo.textContent = `File: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`;
                fileInfo.classList.remove('hidden');

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });

                        // Assume first sheet is the one we want
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];

                        // Convert to JSON
                        uploadedData = XLSX.utils.sheet_to_json(worksheet);

                        // Check if required columns exist
                        if (uploadedData.length > 0) {
                            const firstRow = uploadedData[0];
                            if (!firstRow.hasOwnProperty('nisn') || !firstRow.hasOwnProperty('nama') || !firstRow.hasOwnProperty('kelas')) {
                                showMessage('File Excel harus memiliki kolom: nisn, nama, dan kelas', 'error');
                                uploadedData = null;
                                generateBtn.disabled = true;
                                preview.classList.add('hidden');
                                return;
                            }
                        }

                        // Show preview
                        showPreview(uploadedData);
                        generateBtn.disabled = false;
                    } catch (error) {
                        console.error('Error reading file:', error);
                        showMessage('Terjadi kesalahan saat membaca file. Pastikan file adalah format Excel yang valid.', 'error');
                        uploadedData = null;
                        generateBtn.disabled = true;
                        preview.classList.add('hidden');
                    }
                };
                reader.readAsArrayBuffer(file);
            });

            // Generate passwords and download updated file
            generateBtn.addEventListener('click', function() {
                if (!uploadedData) {
                    showMessage('Silakan unggah file Excel terlebih dahulu.', 'error');
                    return;
                }

                // Validate at least one character type is selected
                if (!includeUppercase.checked && !includeLowercase.checked &&
                    !includeNumbers.checked && !includeSymbols.checked) {
                    showMessage('Pilih setidaknya satu jenis karakter untuk password.', 'error');
                    return;
                }

                // Generate passwords
                const length = parseInt(passwordLength.value);
                const updatedData = uploadedData.map(row => {
                    return {
                        ...row,
                        password: generatePassword(
                            length,
                            includeUppercase.checked,
                            includeLowercase.checked,
                            includeNumbers.checked,
                            includeSymbols.checked
                        )
                    };
                });

                // Create new workbook
                const newWorkbook = XLSX.utils.book_new();
                const newWorksheet = XLSX.utils.json_to_sheet(updatedData);
                XLSX.utils.book_append_sheet(newWorkbook, newWorksheet, 'Data Siswa');

                // Generate nama file sesuai format yang diminta
                const downloadFileName = generateDownloadFileName(originalFileName);

                // Download the file
                XLSX.writeFile(newWorkbook, downloadFileName);

                // Update preview
                showPreview(updatedData);
                showMessage(`File berhasil diunduh dengan nama: ${downloadFileName}`, 'success');
            });

            // Function to generate download file name
            function generateDownloadFileName(originalName) {
                // Hilangkan ekstensi file
                const nameWithoutExtension = originalName.replace(/\.xlsx?$/i, '');
                // Tambahkan "-berpassword.xlsx"
                return `${nameWithoutExtension}-berpassword.xlsx`;
            }

            // Function to generate random password
            function generatePassword(length, useUpper, useLower, useNumbers, useSymbols) {
                const uppercase = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
                const lowercase = 'abcdefghijklmnopqrstuvwxyz';
                const numbers = '0123456789';
                const symbols = '!@#$%^&*';

                let characters = '';
                if (useUpper) characters += uppercase;
                if (useLower) characters += lowercase;
                if (useNumbers) characters += numbers;
                if (useSymbols) characters += symbols;

                // Ensure at least one character from each selected type
                let password = 'PEM';
                if (useUpper) password += uppercase.charAt(Math.floor(Math.random() * uppercase.length));
                if (useLower) password += lowercase.charAt(Math.floor(Math.random() * lowercase.length));
                if (useNumbers) password += numbers.charAt(Math.floor(Math.random() * numbers.length));
                if (useSymbols) password += symbols.charAt(Math.floor(Math.random() * symbols.length));

                // Fill the rest with random characters
                for (let i = password.length; i < length; i++) {
                    password += characters.charAt(Math.floor(Math.random() * characters.length));
                }

                // Shuffle the password to randomize character positions
                return password;
            }

            // Function to show data preview
            function showPreview(data) {
                if (data.length === 0) {
                    tableContainer.innerHTML = '<p>Tidak ada data untuk ditampilkan.</p>';
                    return;
                }

                // Create table
                let tableHTML = '<table><thead><tr>';

                // Add headers
                const headers = Object.keys(data[0]);
                headers.forEach(header => {
                    tableHTML += `<th>${header}</th>`;
                });
                tableHTML += '</tr></thead><tbody>';

                // Add rows (limit to 10 for preview)
                const previewRows = data.slice(0, 10);
                previewRows.forEach(row => {
                    tableHTML += '<tr>';
                    headers.forEach(header => {
                        tableHTML += `<td>${row[header]}</td>`;
                    });
                    tableHTML += '</tr>';
                });

                tableHTML += '</tbody></table>';

                if (data.length > 10) {
                    tableHTML += `<p>Menampilkan 10 dari ${data.length} baris data.</p>`;
                }

                tableContainer.innerHTML = tableHTML;
                preview.classList.remove('hidden');
            }

            // Function to show messages
            function showMessage(text, type) {
                message.textContent = text;
                message.className = type === 'success' ? 'success-message' : 'error-message';
                message.classList.remove('hidden');

                // Auto-hide after 5 seconds
                setTimeout(() => {
                    message.classList.add('hidden');
                }, 5000);
            }
        });
    </script>
</body>
</html>
